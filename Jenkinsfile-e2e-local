#!/usr/bin/env groovy
library 'Simorgh'

def channel = '#simorgh-alarms-jamesdonoh-test'

node {
    properties(
        [
            buildDiscarder(
                logRotator(
                    daysToKeepStr: '10',
                    artifactDaysToKeepStr: '10'
                )
            ),
            parameters(
                [
                    string(defaultValue: 'e2e-reports-integration', name: 'BRANCH')
                ]
            )
        ]
    )
    timeout(time: 240, unit: 'MINUTES') {
        withEnv([
            'CI=true'
        ]) {
            cleanWs() // Clean the workspace

            docker.image(Simorgh.nodeDockerImage()).inside('--ipc host') {
                Simorgh.checkout("${params.BRANCH}", 'simorgh')
                Simorgh.installNodeModules()
                stage ('Localhost Tests') {
                    try {
                        sh script: "npm run build && CYPRESS_ONLY_SERVICE=persian npm run test:ci;"
                    } catch (Exception e) {
                        // catch (FlowInterruptedException interruptEx) {

                        def message = e.toString()
                        slackSend(channel: channel, color: 'danger', message: "Exception: ${message} - status is ${currentBuild.result}")

                        // throw
                    } finally {
                        try {
                            // NB junit will set status to UNSTABLE if it finds test failures
                            // Also by default will throw an exception if it can't find results
                            // NB remove allowEmpty once all jobs must output results
                            junit allowEmptyResults: false, testResults: 'cypress/results/**/*.xml'
                        } finally {
                            def message = "@here ${env.JOB_NAME} finally block ran - status is ${currentBuild.result}"
                            slackSend(channel: channel, color: 'warning', message: message)
                        }
                    }
                }
            }
        }
    }
}
